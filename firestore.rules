rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserRole(userId) {
      return get(/databases/$(database)/documents/employees/$(userId)).data.role;
    }
    
    function isAdmin() {
      return isSignedIn() && (getUserRole(request.auth.uid) == 'Admin' || getUserRole(request.auth.uid) == 'Owner');
    }

    // Colección de Empleados
    // - Los usuarios pueden leer y actualizar su propio perfil.
    // - Los admins pueden leer y escribir en cualquier perfil.
    match /employees/{userId} {
      allow read, update: if isSignedIn() && isOwner(userId);
      allow read, create, update: if isAdmin();
    }

    // Colección de Asistencia (subcolección de empleado)
    // - El empleado puede crear sus propios registros de asistencia.
    // - El empleado puede leer sus propios registros.
    // - Los admins pueden leer los registros de todos.
    match /employees/{userId}/attendance/{docId} {
       allow create, read: if isSignedIn() && isOwner(userId);
       allow read: if isAdmin();
    }

    // Colección de Solicitudes de Ausencia
    // - Cualquier empleado autenticado puede crear una solicitud.
    // - El empleado que la creó puede leerla.
    // - Los admins pueden leer, actualizar (aprobar/rechazar) y borrar todas las solicitudes.
    match /absenceRequests/{requestId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && request.auth.uid == resource.data.employeeId;
      allow read, update, delete: if isAdmin();
    }
    
    // Colecciones de Configuración (Departamentos, Roles, etc.)
    // - Solo los admins pueden modificarlas.
    // - Cualquier empleado autenticado puede leerlas.
    match /departments/{departmentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /roles/{roleId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /absenceTypes/{typeId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}
