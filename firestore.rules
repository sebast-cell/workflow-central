rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth() && exists(/databases/$(database)/documents/employee/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/employee/$(request.auth.uid)).data.role == 'Admin';
    }

    // --- Employee Collection ---
    // Users can read any profile (for lists, etc.)
    // Users can only update their own profile.
    // Admins can create and delete any profile.
    match /employee/{userId} {
      allow read: if isAuth();
      allow create, delete: if isAdmin();
      allow update: if isAuth() && request.auth.uid == userId;
    }

    // --- Attendance Collection ---
    // Admins can read all logs.
    // Employees can read their own logs.
    // Employees can only create logs for themselves.
    match /attendance/{logId} {
      allow read: if isAdmin() || (isAuth() && resource.data.employeeId == request.auth.uid);
      allow create: if isAuth() && request.resource.data.employeeId == request.auth.uid;
      allow write: if isAdmin(); // Admins can edit/delete
    }

    // --- Absence Requests Collection ---
    // Admins can read all requests.
    // Employees can read their own requests.
    // Employees can only create requests for themselves.
    match /absenceRequests/{reqId} {
       allow read: if isAdmin() || (isAuth() && resource.data.employeeId == request.auth.uid);
       allow create: if isAuth() && request.resource.data.employeeId == request.auth.uid;
       allow update: if isAdmin(); // Admins approve/reject
    }

    // --- General Read-Only Collections for All Users ---
    // Any authenticated user can read projects, objectives, and tasks.
    // Only Admins can create, update, or delete them.
    match /projects/{projectId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
     match /objectives/{objectiveId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
     match /tasks/{taskId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // --- Settings Collections ---
    // Only Admins can read or write to any of the settings collections.
    match /{settingCollection}/{settingId} 
      where settingCollection in ['roles', 'departments', 'centers', 'absenceTypes', 'calendars', 'vacationPolicies', 'incentives', 'breaks', 'clockInTypes', 'shifts', 'flexibleSchedules', 'fixedSchedules'] {
      allow read, write: if isAdmin();
    }
  }
}
